class w{constructor(){this.currentView=null,this.router=null,document.addEventListener("keydown",e=>{e.key==="Escape"&&(e.preventDefault(),this.currentView&&this.currentView.goBack&&this.currentView.goBack())}),document.addEventListener("keydown",e=>{this.currentView&&this.currentView.onKeyDown&&this.currentView.onKeyDown(e)}),document.addEventListener("keyup",e=>{this.currentView&&this.currentView.onKeyUp&&this.currentView.onKeyUp(e)}),document.addEventListener("submit",e=>{this.currentView&&this.currentView.onSubmit&&this.currentView.onSubmit(e)}),window.app=this}setCurrentView(e){this.currentView=e}setRouter(e){this.router=e}}class d{constructor(){this.data=null,this.container=null,this.title=null}setTitle(e){this.title=e}render(){if(this.container=document.createElement("div"),this.container.className="view",this.data?.field?.label&&(this.title=this.data.field.label),this.title){const s=document.createElement("h1");s.textContent=this.title,s.classList.add("title"),this.container?.appendChild(s)}const e=this.renderContent();e!=null&&e!=null&&this.container?.appendChild(e);const t=document.getElementById("app");return t&&(t.innerHTML="",t.appendChild(this.container)),this.container}renderContent(){}goBack(){if(window.app&&window.app.router){const e=window.app.router.getCurrentPath(),t=this.getParentPath(e||"");t&&window.app.router.navigate(t)}}getParentPath(e){const t=e.split("/").filter(s=>s);return t.length===0?null:(t.pop(),t.length===0?"/":"/"+t.join("/"))}onKeyDown(e){}onKeyUp(e){}onSubmit(e){}cacheable(){return!0}appear(e){}}class g extends d{constructor(e){super(),this.cacheable=()=>!1,this.setTitle(`Edit ${e.field.label}`),this.value=e.currentValue,this.placeholder=e.field.placeholder,this.onSave=e.onSave,this.field=e.field}renderContent(){const e=document.createElement("div");e.className="text-edit-container";const t=document.createElement("input");return t.type="text",t.className="text-input",t.value=this.value||"",t.placeholder=this.placeholder||"Enter text...",t.addEventListener("focus",()=>{t.setSelectionRange(t.value.length,t.value.length)}),e.appendChild(t),setTimeout(()=>{t.focus()},100),e}onKeyDown(e){switch(document.querySelector(".text-input"),e.key){case"Enter":e.preventDefault(),this.save();break;case"Escape":e.preventDefault(),this.goBack();break}}save(){const t=document.querySelector(".text-input").value;this.onSave&&this.onSave(t),this.goBack()}}class l extends d{constructor(e=[]){super(),this.options=e,this.selectedIndex=0}addItem(e,t){this.options.push({label:e,action:t})}renderContent(){const e=document.createElement("div");return e.className="menu",this.options.forEach((t,s)=>{const i=document.createElement("div");i.className="menu-item",s===this.selectedIndex&&i.classList.add("selected"),i.textContent=t.label||t,i.dataset.index=s.toString(),t.action&&(i.dataset.action=t.action),e.appendChild(i)}),e}onKeyDown(e){switch(e.key){case"ArrowUp":e.preventDefault(),this.selectedIndex=Math.max(0,this.selectedIndex-1),this.updateSelection();break;case"ArrowDown":e.preventDefault(),this.selectedIndex=Math.min(this.options.length-1,this.selectedIndex+1),this.updateSelection();break;case"Enter":e.preventDefault(),this.selectCurrent();break}}updateSelection(){document.querySelectorAll(".menu-item").forEach((t,s)=>{s===this.selectedIndex?t.classList.add("selected"):t.classList.remove("selected")})}selectCurrent(){const e=this.options[this.selectedIndex];e&&e.action&&e.action()}}class C extends d{constructor(){super(),this.cacheable=()=>!1,this.menu=null,this.onSave=null}renderContent(){const e=document.createElement("div");e.className="select-view";const t=this.data?.field;if(this.data?.currentValue,!t||!t.choices){const a=document.createElement("div");return a.className="error-message",a.textContent="No choices available",e.appendChild(a),e}const s=t.choices.map(a=>({label:a.text||a.label,action:()=>{this.data?.onSave&&this.data.onSave(a.value),this.goBack()}}));this.menu=new l(s);const i=this.menu.render();return e.appendChild(i),e}onKeyDown(e){this.menu&&this.menu.onKeyDown(e)}}class x{constructor(){this.routes=new Map,this.views=new Map,this.currentView=null,this.currentPath=null}register(e,t){this.routes.set(e,t),this.registerEditRoutes(e,t)}registerEditRoutes(e,t){const s=this.getChildPath(e,"text-edit");this.routes.set(s,g);const i=this.getChildPath(e,"select-edit");this.routes.set(i,C)}getChildPath(e,t){return e==="/"?"/"+t:e+"/"+t}navigate(e,t=null){if(console.log(`Navigating to: ${e}`),this.views.has(e))this.currentView=this.views.get(e);else{const s=this.routes.get(e);if(!s){console.error(`Route not found: ${e}`);return}this.currentView=new s(t),this.currentView?.cacheable()&&this.views.set(e,this.currentView)}window.app?.setCurrentView(this.currentView),this.currentView?.render(),this.currentPath=e,this.currentView?.appear(t)}getCurrentView(){return this.currentView}getCurrentPath(){return this.currentPath}}class p extends d{constructor(){super(),this.fields={},this.currentFieldIndex=0,this.values={},Object.values(this.fields).forEach(e=>{this.values[e.name]=e.value||""})}addField(e,t,s,i={}){const a={name:e,label:t,type:s,placeholder:i.placeholder,readonly:i.readonly||!1,value:i.value,defaultValue:i.defaultValue,...i};this.fields[a.name]=a,a.defaultValue!==void 0?this.values[a.name]=a.defaultValue:a.value!==void 0&&(this.values[a.name]=a.value)}renderContent(){const e=document.createElement("form");e.className="form";let t=!1;Object.values(this.fields).forEach((i,a)=>{!t&&!i.readonly&&(t=!0,this.currentFieldIndex=a);const h=document.createElement("div");h.className="form-group",h.dataset.fieldIndex=a.toString(),a===this.currentFieldIndex&&(h.classList.add("selected"),h.focus()),i.readonly&&h.classList.add("readonly");const c=document.createElement("label");if(c.textContent=i.label||i.name,h.appendChild(c),i.readonly){const r=document.createElement("div");r.className="field-value readonly",r.textContent=this.values[i.name]||i.value||"",h.appendChild(r)}else if(i.type==="checkbox"){const r=document.createElement("div");r.className="field-value checkbox",r.textContent=this.values[i.name]||i.value?"[X]":"[ ]",r.dataset.fieldName=i.name,h.appendChild(r)}else{const r=document.createElement("div");r.className="field-value",r.textContent=this.values[i.name]||i.value||i.placeholder||"Enter...",h.appendChild(r)}e.appendChild(h)});const s=document.createElement("button");return s.className="btn save-button",s.textContent="Save",s.type="submit",s.dataset.fieldIndex=this.fields.length.toString(),this.currentFieldIndex===Object.keys(this.fields).length&&s.classList.add("selected"),e.appendChild(s),e}onKeyDown(e){switch(e.key){case"ArrowUp":e.preventDefault(),this.navigateField(-1);break;case"ArrowDown":e.preventDefault(),this.navigateField(1);break;case"Tab":e.preventDefault(),this.navigateField(1);break;case"Enter":e.preventDefault(),this.handleEnter();break}}navigateField(e){const t=document.querySelector(".form-group.selected, .save-button.selected");t&&t.classList.remove("selected");let s=this.currentFieldIndex+e;const i=Object.keys(this.fields).length;if(s<0?s=i:s>i&&(s=0),s<i){const a=this.fields[s];if(a&&a.readonly){e>0?s++:s--,this.currentFieldIndex=s,this.navigateField(e);return}}if(this.currentFieldIndex=s,s===i){const a=document.querySelector(".save-button");a&&a.classList.add("selected")}else{const a=document.querySelector(`[data-field-index="${s}"]`);a&&a.classList.add("selected")}}handleEnter(){if(this.currentFieldIndex===Object.keys(this.fields).length)this.save();else{const e=Object.values(this.fields)[this.currentFieldIndex];e&&!e.readonly&&this.editField(e)}}editField(e){if(e.type==="checkbox"){this.values[e.name]=this.values[e.name]?"false":"true";const t=document.querySelector(`[data-field-name="${e.name}"]`);t&&(t.textContent=this.values[e.name]?"[X]":"[ ]")}else if(e.type==="select"){const t=window.app.router?.getCurrentPath(),s=this.getChildPath(t||"","select-edit");window.app?.router?.navigate(s,{field:e,currentValue:this.values[e.name],onSave:i=>{this.values[e.name]=i,this.render()}})}else{const t=window.app?.router?.getCurrentPath(),s=this.getChildPath(t||"","text-edit");window.app?.router?.navigate(s,{field:e,currentValue:this.values[e.name],onSave:i=>{this.values[e.name]=i,this.render()}})}}getChildPath(e,t){return e==="/"?"/"+t:e+"/"+t}save(){document.querySelectorAll(".checkbox").forEach(t=>{const s=t.dataset.fieldName;s&&(this.values[s]=t.textContent==="[X]"?"true":"false")}),this.onSave&&this.onSave(this.values)}onSubmit(e){e.preventDefault(),this.save()}}class m extends d{constructor(e=[]){super(),this.data=e,this.selectedRow=0,this.onSelected=null}setData(e){this.data=e}setOnSelected(e){this.onSelected=e}renderContent(){const e=document.createElement("div");if(e.className="table",this.data.length===0){const c=document.createElement("div");return c.className="empty-message",c.textContent="No data available",e.appendChild(c),e}const t=document.createElement("table");t.classList.add("terminal-table");const s=document.createElement("thead"),i=document.createElement("tr"),a=Object.keys(this.data[0]);a.forEach(c=>{const r=document.createElement("th");r.textContent=c,i.appendChild(r)}),s.appendChild(i),t.appendChild(s);const h=document.createElement("tbody");return this.data.forEach((c,r)=>{const u=document.createElement("tr");r===this.selectedRow&&u.classList.add("selected"),a.forEach(v=>{const f=document.createElement("td");f.textContent=c[v],u.appendChild(f)}),h.appendChild(u)}),t.appendChild(h),e.appendChild(t),e}onKeyDown(e){switch(e.key){case"ArrowUp":e.preventDefault(),this.selectedRow=Math.max(0,this.selectedRow-1),this.updateSelection();break;case"ArrowDown":e.preventDefault(),this.selectedRow=Math.min(this.data.length-1,this.selectedRow+1),this.updateSelection();break;case"Enter":e.preventDefault(),this.selectCurrentRow();break}}updateSelection(){document.querySelectorAll("tbody tr").forEach((t,s)=>{s===this.selectedRow?t.classList.add("selected"):t.classList.remove("selected")})}selectCurrentRow(){if(this.data.length>0&&this.onSelected){const e=this.data[this.selectedRow];this.onSelected(e)}}}class b extends l{constructor(){super(),this.setTitle("Index"),this.addItem("Chats",()=>{window.app.router.navigate("/chats")})}}class E extends m{constructor(){super(),this.setTitle("Chats"),this.error=null}async fetchChats(){this.data=[],fetch("/api/chats").then(e=>e.json()).then(this.onChatsLoaded.bind(this),this.onChatsError.bind(this)).catch(this.onChatsError.bind(this))}onChatsLoaded(e){if(!e.ChatListResponseJSONResponse){this.onChatsError("Failed to fetch chats");return}this.data=e.ChatListResponseJSONResponse,this.render()}onChatsError(e){this.error=e,this.render()}onSelected=e=>{window.app.router.navigate("/chats/details",e)};appear=()=>{this.fetchChats()}}class y extends p{constructor(e){super()}onSave=e=>{fetch(`/api/chats/${this.chat.id}?authorized=${e.authorized}`,{method:"PUT"}).then(t=>{t.ok?this.goBack():console.error("Failed to update chat")})};appear=e=>{this.chat=e,this.setTitle(`Edit Chat ${this.chat.tg_chat_name}`),this.addField("id","ID","text",{defaultValue:this.chat.id,readonly:!0}),this.addField("tg_chat_id","TG Chat ID","text",{value:this.chat.tg_chat_id,readonly:!0}),this.addField("tg_chat_name","TG Chat Name","text",{value:this.chat.tg_chat_name,readonly:!0}),this.addField("authorized","Authorized","checkbox",{value:this.chat.authorized}),this.render()}}class R extends l{constructor(e){super(),this.addItem("Edit Chat",()=>{window.app.router.navigate("/chats/details/edit",this.chat)}),this.addItem("Roles",()=>{window.app.router.navigate("/chats/details/roles",this.chat)}),this.addItem("Users",()=>{window.app.router.navigate("/chats/details/users",this.chat)})}async fetchChat(){fetch(`/api/chats/${this.chat.id}`).then(e=>{if(e.ok)return e.json();throw new Error("Failed to fetch chat")}).then(e=>{this.chat=e,this.render()})}appear=e=>{e&&(this.chat=e),this.setTitle(`Chat Details of ${this.chat.tg_chat_name}`),this.fetchChat()}}class S extends m{constructor(e){super(),this.setTitle("Chat Users"),this.chat=e}async fetchUsers(){this.data=[],fetch(`/api/chats/${this.chat.id}/users`).then(e=>{if(e.ok)return e.json();throw new Error("Failed to fetch users")}).then(e=>{e.UserListResponseJSONResponse&&(this.data=e.UserListResponseJSONResponse,this.render())})}onSelected=e=>{window.app.router.navigate("/chats/details/users/remove",e)};appear=e=>{e&&(this.chat=e),this.fetchUsers()}}class k extends l{constructor(e){super(),this.setTitle("Chat Roles"),this.addItem("Add Role",()=>{window.app.router.navigate("/chats/details/roles/add",e)}),this.addItem("List Roles",()=>{window.app.router.navigate("/chats/details/roles/list",e)})}}class V extends p{constructor(e){super()}onSave=e=>{fetch(`/api/chats/${this.chat.id}/roles`,{method:"POST",body:JSON.stringify({name:e.name})}).then(t=>{t.ok&&this.goBack()})};appear=e=>{e&&(this.chat=e),this.setTitle(`Add Role to Chat ${this.chat.tg_chat_name}`),this.addField("name","Name","text"),this.render()}}class _ extends m{constructor(e){super()}async fetchRoles(){this.data=[],fetch(`/api/chats/${this.chat.id}/roles`).then(e=>{if(e.ok)return e.json();throw new Error("Failed to fetch roles: "+e.statusText)}).then(e=>{e.RoleListResponseJSONResponse&&(this.data=e.RoleListResponseJSONResponse,this.render())})}onSelected=e=>{window.app.router.navigate("/chats/details/roles/list/options",e)};appear=e=>{e&&(this.chat=e,this.setTitle(`Chat ${e.tg_chat_name} Roles List`)),this.fetchRoles()}}class I extends p{constructor(e){super()}async fetchUsers(){this.roleUsers={},this.users=[],fetch(`/api/chats/${this.role.chat_id}/users`).then(e=>{if(e.ok)return e.json()}).then(e=>{this.users=e.UserListResponseJSONResponse}).then(async()=>fetch(`/api/chats/${this.role.chat_id}/roles/${this.role.id}`).then(e=>{if(e.ok)return e.json()})).then(e=>{e.UserListResponseJSONResponse&&e.UserListResponseJSONResponse.forEach(t=>{this.roleUsers[t.tg_user_id]=!0,console.log(this.roleUsers)})}).then(()=>{for(const e of this.users)this.addField(`user_${e.tg_user_id}`,e.tg_user_name,"checkbox",{value:this.roleUsers[e.tg_user_id]||!1});this.render()})}onSave=e=>{var t=[];for(const s of this.users)t.push({user_id:s.id,assign:e[`user_${s.tg_user_id}`]});fetch(`/api/chats/${this.role.chat_id}/roles/${this.role.id}`,{method:"POST",body:JSON.stringify(t)}).then(s=>{s.ok&&this.goBack()})};appear=e=>{e&&(this.role=e),this.setTitle(`Users of ${e.name}`),this.fetchUsers()}}class L extends l{constructor(e){super(),console.log(this),this.addItem("Yes, im sure i want to remove this user from the chat",this.removeUser.bind(this)),this.addItem("Back",this.goBack.bind(this))}appear=e=>{e&&(this.user=e),this.setTitle(`Remove user ${this.user.tg_user_name} from chat ${this.user.tg_chat_name}`),this.render()};async removeUser(){fetch(`/api/chats/${this.user.chat_id}/users/${this.user.id}`,{method:"DELETE"}).then(e=>{e.ok&&this.goBack()})}}class D extends l{constructor(e){super(),this.addItem("Yes, im sure i want to remove this role from the chat",this.removeRole.bind(this)),this.addItem("Back",this.goBack.bind(this))}appear=e=>{e&&(this.role=e),this.setTitle(`Remove role ${this.role.name} from chat ${this.role.tg_chat_name}`),this.render()};async removeRole(){fetch(`/api/chats/${this.role.chat_id}/roles/${this.role.id}`,{method:"DELETE"}).then(e=>{e.ok&&window.app.router.navigate("/chats/details/roles/list")})}}class N extends l{constructor(e){super(),this.addItem("Edit users",()=>{window.app.router.navigate("/chats/details/roles/list/options/manage",this.role)}),this.addItem("Remove role",()=>{window.app.router.navigate("/chats/details/roles/list/options/remove",this.role)})}appear=e=>{e&&(this.role=e),this.setTitle(`Role ${this.role.name} options`),this.render()}}new w;const o=new x;o.register("/",b);o.register("/chats",E);o.register("/chats/details",R);o.register("/chats/details/edit",y);o.register("/chats/details/users",S);o.register("/chats/details/users/remove",L);o.register("/chats/details/roles",k);o.register("/chats/details/roles/add",V);o.register("/chats/details/roles/list",_);o.register("/chats/details/roles/list/options",N);o.register("/chats/details/roles/list/options/remove",D);o.register("/chats/details/roles/list/options/manage",I);window.app.setRouter(o);o.navigate("/",window.app);
